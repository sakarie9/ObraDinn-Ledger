---
import Layout from "../layouts/Layout.astro";

const commitHash = __COMMIT_HASH__;

const faces = Array.from({ length: 60 }, (_, i) => {
  const num = (i + 1).toString().padStart(2, "0");
  return `face_${num}.webp`;
});
---

<Layout title="《奥伯拉丁》命运勘验">
  <div class="flex flex-col gap-5">
    <!-- Header -->
    <div class="flex justify-between items-center mb-5">
      <h1 class="text-xl sm:text-2xl font-bold font-cn">
        《奥伯拉丁》命运勘验
      </h1>
      <div class="flex gap-3 items-center">
        <a
          href={`${import.meta.env.BASE_URL}/about`}
          class="text-[#AAAA88] hover:text-[#DDDDAA] transition-colors text-sm sm:text-base"
        >
          关于
        </a>
        <button id="reset-btn" class="btn-lg cursor-pointer">重置</button>
      </div>
    </div>

    <!-- Grid -->
    <div
      class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-6 gap-4"
    >
      {
        faces.map((face, index) => (
          <a
            href={`${import.meta.env.BASE_URL}/face/${index + 1}`}
            class="block aspect-square relative"
            data-face={face}
          >
            <div class="face-card loading">
              <div class="face-card-loader">
                <div class="face-card-spinner" />
              </div>
              <img
                src={`${import.meta.env.BASE_URL}/FacesHi/${face}`}
                alt={`Face ${index + 1}`}
                loading="lazy"
                class="face-card-img"
              />
            </div>
            <div class="face-check" aria-hidden="true">
              ✓
            </div>
            <div class="absolute bottom-1 right-1 text-sm font-semibold text-gray-300 font-en opacity-70">
              {index + 1}
            </div>
          </a>
        ))
      }
    </div>

    <!-- Footer -->
    <footer
      class="border-t border-[#AAAA88] mt-16 pt-8 pb-8 text-center text-s text-[#AAAA88] font-mixed"
    >
      <div class="space-y-3 max-w-lg mx-auto">
        <p>
          <a
            href={`${import.meta.env.BASE_URL}/about`}
            class="hover:text-[#DDDDAA] transition-colors"
          >
            关于本项目
          </a>
          {" • "}
          <a
            href="https://github.com/sakarie9/ObraDinn-Ledger"
            target="_blank"
            rel="noopener noreferrer"
            class="hover:text-[#DDDDAA] transition-colors"
          >
            GitHub 仓库
          </a>
          {" • "}
          <a
            href="https://github.com/Yide-Zhang/ObraDinn-HintsAndCheck"
            target="_blank"
            rel="noopener noreferrer"
            class="hover:text-[#DDDDAA] transition-colors"
          >
            原始项目
          </a>
        </p>
        <p>© 2026 • 《奥伯拉丁的回归》命运勘验工具 • {commitHash}</p>
        <p class="text-[#777766]">
          游戏资源版权归 Lucas Pope 所有 • 本项目仅供学习交流使用
        </p>
      </div>
    </footer>
  </div>
</Layout>

<script>
  import { resetData, loadState } from "../scripts/store";

  const SCROLL_KEY = "index-scroll-position";
  const BASE_URL = import.meta.env.BASE_URL;

  // Save scroll position before leaving the page
  document.addEventListener("astro:before-preparation", (e: any) => {
    const fromPath = window.location.pathname;
    const toPath = new URL(e.to.href).pathname;

    // Save scroll position when navigating from index to face page
    if (fromPath === BASE_URL + "/" || fromPath === BASE_URL) {
      if (toPath.includes("/face/")) {
        sessionStorage.setItem(SCROLL_KEY, window.scrollY.toString());
      } else {
        // Clear scroll position when navigating to other pages
        sessionStorage.removeItem(SCROLL_KEY);
      }
    }
  });

  // Restore scroll position after page swap
  document.addEventListener("astro:after-swap", () => {
    const currentPath = window.location.pathname;
    if (currentPath === BASE_URL + "/" || currentPath === BASE_URL) {
      const savedScroll = sessionStorage.getItem(SCROLL_KEY);
      if (savedScroll) {
        window.scrollTo(0, parseInt(savedScroll, 10));
      }
    }
  });

  document.addEventListener("astro:page-load", () => {
    // Handle individual image loading
    const images = document.querySelectorAll(".face-card-img");

    images.forEach((img) => {
      if (img instanceof HTMLImageElement) {
        const card = img.closest(".face-card");

        const handleLoad = () => {
          if (card) {
            card.classList.remove("loading");
            card.classList.add("loaded");
          }
        };

        if (img.complete) {
          handleLoad();
        } else {
          img.addEventListener("load", handleLoad);
          img.addEventListener("error", handleLoad); // Handle errors gracefully
        }
      }
    });

    // Reset button
    const resetBtn = document.getElementById("reset-btn");
    if (resetBtn && !resetBtn.hasAttribute("data-listener-attached")) {
      resetBtn.setAttribute("data-listener-attached", "true");

      resetBtn.addEventListener("click", () => {
        if (confirm("确定要清空所有身份推测和提示进度吗？(此操作不可撤销)")) {
          resetData();
          alert("所有进度已重置。");
          window.location.reload();
        }
      });
    }

    // Show checkmarks on fully verified faces
    const state = loadState();
    for (const [filename, s] of Object.entries(state)) {
      if (s.status === "verified" && s.fate_status === "verified") {
        const link = document.querySelector(`[data-face="${filename}"]`);
        const check = link?.querySelector(".face-check");
        if (check) check.classList.add("visible");
      }
    }
  });
</script>
